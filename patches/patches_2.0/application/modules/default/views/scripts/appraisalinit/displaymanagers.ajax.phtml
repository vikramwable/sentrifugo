<?php 

/********************************************************************************* 
 *  This file is part of Sentrifugo.
 *  Copyright (C) 2014 Webshar
 *   
 *  Sentrifugo is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  Sentrifugo is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with Sentrifugo.  If not, see <http://www.gnu.org/licenses/>.
 *
 *  Sentrifugo Support <support@webshar.org>
 ********************************************************************************/

$levels = $this->levels;
$managers = $this->managers;
$init_id = $this->init_id;
$context = $this->context;
$line1_data = $this->line1_data;
$line_managers = $this->line_managers;
$line1_id = $this->line1_id;
?>
<div class="total-form-controller"  style="padding-top: 0px;">
<?php 
for($i=1;$i<=$levels;$i++)
{
?>
    <div class="new-form-ui">
        <label>L<?php echo $i;?> Manager</label>
        <div class="division">
            <select name="sel_line[<?php echo $i;?>]" class="sel_line_managers" id="idsel_line_<?php echo $i;?>" data-level="<?php echo $i;?>" data-status="<?php echo ($i==$levels)?"last":"level";?>">
<?php 
    if($context == 'add')
    {
?>
                <option value="">Select L<?php echo $i;?> Manager</option>
<?php 
        if(count($managers) > 0 && $i == 1)
        {
            foreach($managers as $manager)
            {
?>
                <option value="<?php echo $manager['user_id'];?>"><?php echo $manager['userfullname'];?></option>
<?php                
            }
        }
    }
    else 
    {
?>
        <option value="">Select L<?php echo $i;?> Manager</option>
<?php 
        if($i == 2 && count($managers) > 0)
        {
            foreach($managers as $manager)
            {
?>
                <option value="<?php echo $manager['user_id'];?>"><?php echo $manager['userfullname'];?></option>
<?php                
            }            
        }
    }
?>
            </select>
        </div>
    </div>
<?php    
}
?>
    
</div>
<div id="iddiv_employees" class="emmp_sel_div">
    
</div>
<div class="clear"></div>
<script type="text/javascript">
var clear_lines = function(level)
{
    level = level + 1;
    var tot_levels = parseInt($('#idsel_levels').val());
    for(var i = level;i<= tot_levels;i++)
    {
        $('#idsel_line_'+i).find("option[value!='']").remove();
        $('#idsel_line_'+i).val('');
        apply_select2();
    }
}
$(document).ready(function(){
    $('.sel_line_managers').change(function(){
        var level = parseInt($(this).attr('data-level'));
        var status = $(this).attr('data-status');
        var val = $(this).val();
        if(val !== '')
        {            
            if(status != 'last')
            {                
                var options = $(this).find('option[value!=""][value!="'+val+'"]');
                var new_level = level + 1;
                clear_lines(level);
                $(options).clone().appendTo('#idsel_line_'+new_level);
                $('#idsel_line_'+new_level).val('');
                apply_select2();
            }
            else
            {                
            	$.blockUI({ width:'50px',message: $("#spinner").html() });
                var params = $('select.sel_line_managers').serializeArray();
                var param_str = '';
                $.each(params,function(index,value){                    
                    param_str +=  '"'+value.name+'":"'+value.value+'",';
                });
                
                var new_params = '{'+param_str+'"init_id":"<?php echo $init_id;?>","context":"<?php echo $context;?>","line1_id":"<?php echo $line1_id;?>"'  +'}';
                
                $.post(base_url+'/appraisalinit/displayemployees/format/html',$.parseJSON(new_params),function(data){
                    $('#iddiv_employees').html(data);
                    $.unblockUI;
                },'html');
            }
        }
        else
        {
            $('#iddiv_employees').html('');
            clear_lines(level);
            apply_select2();
        }
    });
<?php 
if($context == 'edit')
{
?>
    $('#idsel_line_1').html("<option value='<?php echo $line1_data['user_id'];?>'><?php echo $line1_data['userfullname'];?></option>");
<?php 
    if($levels == 1)
    {
?>
        $('#idsel_line_1').trigger('change');
<?php         
    }
?>
    
<?php
    if($levels>1)
    {
        for($i=2;$i<=$levels;$i++)
        {
?>
		<?php if(isset($line_managers['line_manager_'.$i])) { ?>
        	$('#idsel_line_<?php echo $i;?>').val('<?php echo $line_managers['line_manager_'.$i];?>');
        	$('#idsel_line_<?php echo $i;?>').trigger('change');
        <?php } ?>
<?php         
        }
    }
}
?>
    apply_select2();
});//end of ready function
</script>
